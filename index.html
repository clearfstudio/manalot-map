<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>都道府県クイズ</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #f0f8ff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Arial", sans-serif;
    }

#game-container {
  position: relative;
  width: 90vw;
  height: 87vh;
  margin: auto;
  border-radius: 20px;
  overflow: hidden;
  background-color: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  font-size: 28px;

  /* メインコンテンツの中央寄せ設定 */
  display: flex;
  flex-direction: column;
  align-items: center;        /* 左右中央に揃える */
  justify-content: flex-start; /* 上寄せ。必要に応じてcenterにしてもOK */
  padding: 20px;              /* 中央のUIと端の絶対配置が干渉しないよう余白 */
}
    #title-image {
      height: 100%;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }

    .menu-buttons {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      z-index: 10;
    }

.menu-buttons button {
  padding: 10px 24px;
  font-size: 20px;
  font-weight: bold;                       /* 文字を太く */
  border: 3px solid #e86c00;               /* 濃いオレンジの太枠 */
  border-radius: 10px;
  background-color: #ffffff;               /* 白背景 */
  color: #e86c00;                          /* 文字色もオレンジ */
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 3px 3px 8px rgba(0,0,0,0.2);  /* しっかりした影 */
}

.menu-buttons button:hover {
  background-color: #fff1e0;               /* ホバー時のほんのり色付き */
  box-shadow: 4px 4px 10px rgba(0,0,0,0.3); /* ホバー時に影を強調 */
}

#back-button {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10;
  padding: 10px 10px;
  background-color: #666;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
}

ruby {
  font-size: 28px; /* 漢字のサイズ */
}

rt {
  font-size: 14px; /* ふりがなのサイズ */
  color: #555;
}

#mode-banner {
  position: absolute;
  top: 10px;
  left: 10px;
  padding: 8px 16px;
  background-color: #e86c00;
  color: white;
  font-size: 16px;
  font-weight: bold;
  border-radius: 8px;
  z-index: 20;
  box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
}

input[type="radio"] {
  transform: scale(1.8);
  margin-right: 10px;     /* ラベルとの間に余白 */
}

#japan-map {
  position: absolute;
  top: 0;
  left: 50%;                      /* 画面の幅の中央を基準に */
  transform: translateX(-50%);    /* 画像の幅の半分だけ左にずらす */
  height: 100%;
  z-index: 5;
  pointer-events: none;
}

#highlight-pref {
  position: absolute;
  top: 0;
  left: 50%;                      /* 画面の幅の中央を基準に */
  transform: translateX(-50%);    /* 画像の幅の半分だけ左にずらす */
  height: 100%;
  z-index: 1;
}

#question-text {
  position: absolute;
  top: 100px;
  left: 20px;
  font-size: 28px;
  font-weight: bold;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 8px 16px;
  border-radius: 8px;
  z-index: 10;
}

#choice-buttons {
  position: absolute;
  bottom: 70px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 15;
}

#choice-buttons button {
  font-size: 20px;
  padding: 10px 20px;
  border: 2px solid #e86c00;
  border-radius: 8px;
  width: 200px;
  background-color: white;
  color: #e86c00;
  font-weight: bold;
  cursor: pointer;
}

#next-button-area {
  position: absolute;
  bottom: 15px;
  right: 20px;
  z-index: 20;
}

#next-button {
  padding: 8px 15px;
  font-size: 18px;
  font-weight: bold;
  background-color: #e86c00;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
}

.choice-wrapper {
  display: flex;
  align-items: center;
  gap: 10px; /* マークとボタンの間隔 */
}

.result-mark {
  font-size: 32px;
  font-weight: bold;
  color: #333;
  width: 35px;
  text-align: center;
}

#result-message {
  text-align: center;
  font-size: 24px;
  font-weight: bold;
}

.result-title {
  font-size: 28px;
  margin-bottom: 20px;
  color: #e86c00;
}

#score-display {
  font-size: 60px;
  font-weight: bold;
  color: #333;
  margin: 20px 0;
}

#score-number {
  font-size: 60px;
}

.score-unit {
  font-size: 28px;
  margin-left: 8px;
  color: #444;
}

#result-comment {
  font-size: 24px;
  color: #555;
  margin-top: 20px;
  min-height: 2em;
}

#restart-button {
  display: block;
  margin: 50px auto 0;
  padding: 12px 24px;
  font-size: 18px;
  background-color: #888;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

#result-wrapper {
  border: 4px solid orange;
  border-radius: 20px;
  padding: 30px;
  width: 400px;
  height: 450px;
  margin: 60px auto;
  background-color: #fff8f0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

#input-area {
  text-align: center;
  position: absolute;
  right: 20px;
  top: 180px;
  z-index: 100;
}

#text-answer {
  width: 200px;
  font-size: 24px;
  padding: 12px;
  border: 2px solid #ccc;
  border-radius: 8px;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  outline: none;
  box-sizing: border-box;
}

#check-button-area {
  margin-top: 5px;
  text-align: right;
}

#check-button {
  padding: 12px 24px;
  font-size: 18px;
  background-color: #3399ff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 16px;
}

#answer-result {
  font-size: 26px;
  font-weight: bold;
  margin-bottom: 10px;
  height: 3em;
  color: red;
}

#question-count {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 15px;
  text-align: left;
  color: #333;
}

/* 47枚の白シルエット層：線画の下に敷く */
#silhouette-layer {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  height: 100%;
  width: auto;
  z-index: 2; /* 地図線画より下 */
}

/* 各シルエット画像（クリック対象） */
.pref-sil {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  height: 100%;
  width: auto;
  z-index: 2;
  pointer-events: none;
  cursor: pointer;
}

#confirm-button {
  position: absolute;
  bottom: 30px;
  right: 20px;
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background-color: #e86c00;
  color: #fff;
  border: none;
  font-size: 22px;
  font-weight: bold;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.25);
  cursor: pointer;
  z-index: 20;
}

#confirm-button:active {
  transform: translateX(0) scale(0.98);
}

#loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  z-index: 999;
  font-weight: bold;
}
#loading-bar {
  width: 60%;
  max-width: 400px;
  height: 10px;
  background: #eee;
  border-radius: 999px;
  overflow: hidden;
}
#loading-bar > div {
  height: 100%;
  width: 0%;
  background: #e86c00;
  transition: width 0.1s linear;
}
#loading-text { color: #333; }

/* 場所クイズ：判定表示のラッパ（右寄り・上下センター） */
#map-result-wrap {
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 10px;
  z-index: 30;
}

/* 角丸の判定パネル */
#map-result-panel {
  background: rgba(255,255,255,0.95);
  border: 3px solid #e86c00;
  border-radius: 16px;
  padding: 14px 18px;
  min-width: 220px;
  text-align: center;
  box-shadow: 2px 4px 10px rgba(0,0,0,0.15);
  font-weight: bold;
}

#map-result-panel .result-text {
  font-size: 28px;
  line-height: 1.3;
}

#map-result-panel .correct { color: red; }  /* 緑 */
#map-result-panel .wrong   { color: red; }  /* 赤 */

/* “つぎへ”ボタン（既存と統一感） */
#map-next-area #next-button {
  padding: 8px 15px;
  font-size: 18px;
  font-weight: bold;
  background-color: #e86c00;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
}

.dim-wrong {
  filter: grayscale(100%) brightness(85%);
  opacity: 0.9;
}

  </style>
</head>
<body>
  <div id="game-container">
  </div>
  <canvas id="confetti-canvas" style="position:fixed; top:0; left:0; pointer-events:none; z-index:999;"></canvas>

<script>

const prefectures = [
  { id: 1, name: "北海道", yomi: "ほっかいどう" },
  { id: 2, name: "青森県", yomi: "あおもりけん" },
  { id: 3, name: "秋田県", yomi: "あきたけん" },
  { id: 4, name: "岩手県", yomi: "いわてけん" },
  { id: 5, name: "山形県", yomi: "やまがたけん" },
  { id: 6, name: "宮城県", yomi: "みやぎけん" },
  { id: 7, name: "新潟県", yomi: "にいがたけん" },
  { id: 8, name: "福島県", yomi: "ふくしまけん" },
  { id: 9, name: "栃木県", yomi: "とちぎけん" },
  { id: 10, name: "茨城県", yomi: "いばらきけん" },
  { id: 11, name: "群馬県", yomi: "ぐんまけん" },
  { id: 12, name: "埼玉県", yomi: "さいたまけん" },
  { id: 13, name: "千葉県", yomi: "ちばけん" },
  { id: 14, name: "東京都", yomi: "とうきょうと" },
  { id: 15, name: "神奈川県", yomi: "かながわけん" },
  { id: 16, name: "山梨県", yomi: "やまなしけん" },
  { id: 17, name: "静岡県", yomi: "しずおかけん" },
  { id: 18, name: "長野県", yomi: "ながのけん" },
  { id: 19, name: "富山県", yomi: "とやまけん" },
  { id: 20, name: "岐阜県", yomi: "ぎふけん" },
  { id: 21, name: "愛知県", yomi: "あいちけん" },
  { id: 22, name: "石川県", yomi: "いしかわけん" },
  { id: 23, name: "福井県", yomi: "ふくいけん" },
  { id: 24, name: "滋賀県", yomi: "しがけん" },
  { id: 25, name: "三重県", yomi: "みえけん" },
  { id: 26, name: "京都府", yomi: "きょうとふ" },
  { id: 27, name: "奈良県", yomi: "ならけん" },
  { id: 28, name: "和歌山県", yomi: "わかやまけん" },
  { id: 29, name: "大阪府", yomi: "おおさかふ" },
  { id: 30, name: "兵庫県", yomi: "ひょうごけん" },
  { id: 31, name: "岡山県", yomi: "おかやまけん" },
  { id: 32, name: "鳥取県", yomi: "とっとりけん" },
  { id: 33, name: "島根県", yomi: "しまねけん" },
  { id: 34, name: "広島県", yomi: "ひろしまけん" },
  { id: 35, name: "山口県", yomi: "やまぐちけん" },
  { id: 36, name: "香川県", yomi: "かがわけん" },
  { id: 37, name: "徳島県", yomi: "とくしまけん" },
  { id: 38, name: "高知県", yomi: "こうちけん" },
  { id: 39, name: "愛媛県", yomi: "えひめけん" },
  { id: 40, name: "福岡県", yomi: "ふくおかけん" },
  { id: 41, name: "大分県", yomi: "おおいたけん" },
  { id: 42, name: "佐賀県", yomi: "さがけん" },
  { id: 43, name: "長崎県", yomi: "ながさきけん" },
  { id: 44, name: "熊本県", yomi: "くまもとけん" },
  { id: 45, name: "宮崎県", yomi: "みやざきけん" },
  { id: 46, name: "鹿児島県", yomi: "かごしまけん" },
  { id: 47, name: "沖縄県", yomi: "おきなわけん" }
];

  let questionCount = 0; //問題数
  let quizMode = ""; //選択モード
  let questionList = []; //生成された問題リスト
  let correctCount = 0; //正解数
  let currentQuestionNumber = 1; //今何問目
  let selectedPrefId = null; // 場所モードで使用する変数
  const maskImages = {};          // 当たり判定用に読み込む白シルエット画像（id -> Image）
  let hitMapCanvas = null, hitMapCtx = null;
  let hitScaleX = 1, hitScaleY = 1;
  const imgCache = {};
  let hitMapReady = false;
  let mapSupported = true;

function preloadImages(urls, onProgress) {
  let loaded = 0, total = urls.length;
  return Promise.all(urls.map(url => new Promise((resolve, reject) => {
    if (imgCache[url]?.complete) {
      loaded++; onProgress?.(loaded, total); return resolve(imgCache[url]);
    }
    const img = new Image();            // 同一オリジン前提（Live Server / GitHub Pages）
    img.onload = () => { loaded++; onProgress?.(loaded, total); resolve(img); };
    img.onerror = reject;
    img.src = url;
    imgCache[url] = img;
  })));
}

function showLoadingOverlay() {
  const container = document.getElementById("game-container");
  container.innerHTML = `
    <div id="loading-overlay">
      <div id="loading-text">画像を読みこんでいます… 0%</div>
      <div id="loading-bar"><div></div></div>
    </div>
  `;
}

// 最大幅(例: 1200px)でヒットマップを作る。縦横比は地図に合わせて自動調整。
async function buildHitMap(maxWidth = 1200) {
  const mapImg = imgCache["images/japan.png"]; // 事前プリロード済を想定
  const natW = mapImg.naturalWidth || mapImg.width;
  const natH = mapImg.naturalHeight || mapImg.height;

  // 端末に優しい縮小サイズを計算
  const targetW = Math.min(maxWidth, natW);
  const targetH = Math.round(natH * (targetW / natW));

  // 表示(=地図のnatural)からヒットマップ縮小座標へ変換する係数
  hitScaleX = targetW / natW;
  hitScaleY = targetH / natH;

  // ヒットマップ本体
  hitMapCanvas = document.createElement('canvas');
  hitMapCanvas.width = targetW;
  hitMapCanvas.height = targetH;
  hitMapCtx = hitMapCanvas.getContext('2d');

  // 作業用キャンバス
  const tmp = document.createElement('canvas');
  tmp.width = targetW;
  tmp.height = targetH;
  const tctx = tmp.getContext('2d');

  // ★ 超高速：合成モードで一発塗り
  for (const p of prefectures) {
    tctx.clearRect(0, 0, targetW, targetH);

    // 白シルエットを縮小描画
    const mask = imgCache[`images/${p.id}-1.png`];
    tctx.globalCompositeOperation = 'source-over';
    tctx.drawImage(mask, 0, 0, targetW, targetH);

    // マスクの不透明部分にだけ県ID色を流し込む
    tctx.globalCompositeOperation = 'source-in';
    tctx.fillStyle = `rgb(${p.id},0,0)`; // R=県ID
    tctx.fillRect(0, 0, targetW, targetH);

    // ヒットマップに合成
    tctx.globalCompositeOperation = 'source-over';
    hitMapCtx.drawImage(tmp, 0, 0);
  }
}

async function tryBuildHitMapWithFallback() {
  // 端末が重い場合に備えて、段階的に小さくして再試行
  const candidates = [1000, 800, 600];
  for (const w of candidates) {
    try {
      await buildHitMap(w);           // ← すでにある buildHitMap を使用
      // taint/メモリ自己診断（1px 読めなければ例外）
      hitMapCtx.getImageData(0, 0, 1, 1);
      hitMapReady = true;
      return true;
    } catch (e) {
      console.warn('buildHitMap failed at width', w, e);
      // 次の幅で再挑戦
    }
  }
  // すべて失敗 → 非対応として扱う
  mapSupported = false;
  hitMapReady = false;
  return false;
}

window.addEventListener("DOMContentLoaded", async () => {
  // 1) ローディングUI
  showLoadingOverlay();

  // 2) プリロード対象（線画 + 白47 + 橙47）
  const urls = [
    "images/japan.png",
    ...prefectures.map(p => `images/${p.id}-1.png`),
    ...prefectures.map(p => `images/${p.id}-2.png`)
  ];
  const txt = () => document.getElementById("loading-text");
  const bar = () => document.querySelector("#loading-bar > div");

  try {
    await preloadImages(urls, (loaded, total) => {
      const pct = Math.floor(loaded / total * 100);
      if (txt()) txt().textContent = `画像を読みこんでいます… ${pct}%`;
      if (bar()) bar().style.width = `${pct}%`;
    });

    // マスク用キャッシュへ（白シルエット）
    prefectures.forEach(p => { maskImages[p.id] = imgCache[`images/${p.id}-1.png`]; });

    if (txt()) txt().textContent = "地図の当たり判定を準備中…";
    await tryBuildHitMapWithFallback();

    // 3) プリロード完了 → タイトルへ
    showTitleScreen();
  } catch (e) {
    if (txt()) txt().textContent = "読み込みに失敗しました。リロードしてください。";
    console.error(e);
  }
});

  function showTitleScreen() {
    questionCount = 0;
    quizMode = "";
    questionList = [];
    correctCount = 0;
    currentQuestionNumber = 1;
    selectedPrefId = null;
    const container = document.getElementById("game-container");

    container.innerHTML = `
      <img id="title-image" src="images/title.png" alt="タイトル画像">
      <div class="menu-buttons">
        <button onclick="selectQuestionCount('lower')">１～３ねんせい　とどうふけんのなまえ</button>
        <button onclick="selectQuestionCount('upper')">４年生以上　都道府県の名前</button>
        <button onclick="selectQuestionCount('map')"><ruby style="font-size: 20px; font-weight: bold; color: #e86c00;">全学年<rt style="font-size: 12px; color: #e86c00;">ぜんがくねん</rt></ruby>　<ruby style="font-size: 20px; font-weight: bold; color: #e86c00;">都道府県<rt style="font-size: 12px; color: #e86c00;">とどうふけん</rt></ruby>の<ruby style="font-size: 20px; font-weight: bold; color: #e86c00;">場所<rt style="font-size: 12px; color: #e86c00;">ばしょ</rt></ruby></button>
      </div>
    `;

if (!mapSupported) {
  const mapBtn = document.querySelector('.menu-buttons button:nth-child(3)');
  if (mapBtn) {
    mapBtn.disabled = true;
    mapBtn.title = "このデバイスは場所クイズに対応していません";
    mapBtn.style.opacity = '0.5';
    mapBtn.style.cursor = 'not-allowed';
  }
}
  }

  function selectQuestionCount(mode) {
    quizMode = mode;
    const container = document.getElementById("game-container");
    const modeLabel = {
        lower: "とどうふけん　なまえクイズ",
        upper: "都道府県　名前クイズ",
        map: "都道府県　場所クイズ"
    };

    container.innerHTML = `
    <div id="mode-banner">${modeLabel[mode]}</div>
    <button id="back-button" onclick="showTitleScreen()">もどる</button>
      <div style="padding: 30px; font-size: 28px;">
        <h2 style="font-size: 28px;"><ruby>問題<rt>もんだい</rt></ruby>の<ruby>数<rt>かず</rt></ruby>をえらんでね</h2>
        <label><input type="radio" name="qcount" value="5" checked> ５<ruby>問<rt>もん</rt></ruby></label><br>
        <label><input type="radio" name="qcount" value="10"> １０<ruby>問<rt>もん</rt></ruby></label><br>
        <label><input type="radio" name="qcount" value="20"> ２０<ruby>問<rt>もん</rt></ruby></label><br>
        <label><input type="radio" name="qcount" value="47"> ４７<ruby>問<rt>もん</rt></ruby>（ぜんぶ）</label><br><br>

        <button onclick="startQuizWithMode('${mode}')" style="
          margin-top: 30px;
          padding: 12px 24px;
          font-size: 24px;
          font-weight: bold;
          border: 3px solid #e86c00;
          border-radius: 10px;
          background-color: #ffffff;
          color: #e86c00;
          cursor: pointer;
          box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
        ">クイズスタート！</button>
      </div>
    `;
  }

function startQuizWithMode(mode) {
  const selected = document.querySelector('input[name="qcount"]:checked');
  questionCount = parseInt(selected.value, 10);

  questionList = shuffle([...prefectures]).slice(0, questionCount);
  correctCount = 0;

  // モードに応じてクイズ開始
  if (mode === "lower") {
    startLowerGradeQuiz();
  } else if (mode === "upper") {
    startUpperGradeQuiz();
  } else if (mode === "map") {
    startMapGame();
  }
}

// 配列をシャッフルする関数（Fisher-Yates）
function shuffle(array) {
  const result = [...array];
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

function startLowerGradeQuiz() {
  const container = document.getElementById("game-container");
  const currentPref = questionList[0]; // 出題中の都道府県

  const modeLabel = {
    lower: "とどうふけん　なまえクイズ",
    upper: "都道府県　名前クイズ",
    map: "都道府県　場所クイズ"
  };

  // 正解 + ダミー3つを選択肢として用意
  const choices = [currentPref];
  const others = shuffle(prefectures.filter(p => p.id !== currentPref.id)).slice(0, 3);
  choices.push(...others);

  const shuffledChoices = shuffle(choices);

  // innerHTML 出力（選択肢ボタン生成）
  container.innerHTML = `
    <div id="mode-banner">${modeLabel[quizMode]}</div>
    <button id="back-button" onclick="showTitleScreen()">もどる</button>

    <img id="japan-map" src="images/japan.png" alt="日本地図" />
    <img id="highlight-pref" src="images/${currentPref.id}-2.png" alt="出題県" />

    <div id="question-text"><div id="question-count">もんだい ${currentQuestionNumber} / ${questionCount}</div>
この　<ruby>都道府県<rt>とどうふけん</rt></ruby>の<br><ruby>名前<rt>なまえ</rt></ruby>は？</div>

<div id="choice-buttons">
  ${shuffledChoices.map(pref => `
    <div class="choice-wrapper">
      <div class="result-mark"></div> <!-- 先に表示 -->
      <button onclick="checkAnswer(${pref.id}, this)">
        <ruby>${pref.name}<rt>${pref.yomi}</rt></ruby>
      </button>
    </div>
  `).join('')}
</div>

    <div id="next-button-area"></div>
  `;
}

function checkAnswer(selectedId, clickedButton) {
  const correctId = questionList[0].id;
  const wrappers = document.querySelectorAll('.choice-wrapper');

  wrappers.forEach(wrapper => {
    const btn = wrapper.querySelector('button');
    const mark = wrapper.querySelector('.result-mark');
    const isCorrect = btn.innerText.includes(prefectures.find(p => p.id === correctId).name);

    if (isCorrect) {
      btn.style.backgroundColor = "#c8f7c5";
      btn.style.borderColor = "green";
      mark.textContent = "⭕";
    } else if (btn === clickedButton) {
      btn.style.backgroundColor = "#f8cccc";
      btn.style.borderColor = "red";
      mark.textContent = "❌";
    }

    btn.disabled = true;
  });

  if (selectedId === correctId) {
    correctCount++;
  }

  // つぎへボタン表示
  document.getElementById("next-button-area").innerHTML = `
    <button id="next-button" onclick="nextQuestion()">つぎへ →</button>
  `;
}

function nextQuestion() {
  // 今の問題をリストから削除
  questionList.shift();
  currentQuestionNumber++;

  if (questionList.length === 0) {
    // 成績発表（仮）
    showResultScreen();
  } else {
    if (quizMode === "lower") {
      startLowerGradeQuiz();
    } else if (quizMode === "upper") {
      startUpperGradeQuiz();
    } else if (quizMode === "map") {
      startMapGame(); // もし地図クイズモードがあるなら
    }
  }
}

function showResultScreen() {
  const modeLabel = {
    lower: "とどうふけん　なまえクイズ",
    upper: "都道府県　名前クイズ",
    map: "都道府県　場所クイズ"
  };
  const container = document.getElementById("game-container");

  // リザルト画面の初期表示（タイトルとスロット数字用エリア）
  container.innerHTML = `
  <div id="mode-banner">${modeLabel[quizMode]}</div>
  <div id="result-wrapper">
    <div id="result-message">
      <div class="result-title">あなたの<ruby>成績<rt>せいせき</rt></ruby></div>
      <div id="score-display"><span id="score-number">000</span> <span class="score-unit">てん</span></div>
      <div id="result-comment"></div>
    </div>
    <button id="restart-button" onclick="showTitleScreen()">さいしょにもどる</button>
  </div>
  `;

  // スロット風数字表示
  const scoreElement = document.getElementById("score-number");
  const finalScore = Math.floor((correctCount / questionCount) * 100);
  let current = 0;
  const duration = 1000;
  const steps = 30;
  const interval = duration / steps;
  const increment = Math.ceil(finalScore / steps);

  const slotInterval = setInterval(() => {
    current += increment;
    if (current >= finalScore) {
      current = finalScore;
      clearInterval(slotInterval);

      // コメント表示
      const comment = getCommentForScore(finalScore);
      document.getElementById("result-comment").innerHTML = comment;
      if (finalScore === 100) {
        launchConfetti();
      }
    }
    scoreElement.textContent = current.toString().padStart(3, "0");
  }, interval);

}

// スコアに応じたコメント
function getCommentForScore(score) {
  if (score < 50) {
    return `つぎは　もっと<ruby style="font-size: 24px;">高得点<rt>こうとくてん</rt></ruby>をめざそう！`;
  } else if (score <= 80) {
    return `この<ruby style="font-size: 24px;">調子<rt>ちょうし</rt></ruby>で　がんばろう！`;
  } else if (score < 100) {
    return `おしい！　もうちょっとで<ruby style="font-size: 24px;">満点<rt>まんてん</rt></ruby>だ！`;
  } else {
    return `おめでとう！　<ruby style="font-size: 24px;">全問正解<rt>ぜんもんせいかい</rt></ruby>だよ！`;
  }
}

function launchConfetti() {
  const canvas = document.getElementById('confetti-canvas');
  const ctx = canvas.getContext('2d');

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const confettiCount = 150;
  const confetti = [];

  for (let i = 0; i < confettiCount; i++) {
    confetti.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height - canvas.height,
      r: Math.random() * 6 + 4,
      d: Math.random() * confettiCount,
      color: `hsl(${Math.random() * 360}, 70%, 60%)`,
      tilt: Math.random() * 10 - 10,
      tiltAngleIncremental: Math.random() * 0.07 + 0.05,
      tiltAngle: 0
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confetti.forEach((c, i) => {
      ctx.beginPath();
      ctx.lineWidth = c.r;
      ctx.strokeStyle = c.color;
      ctx.moveTo(c.x + c.tilt + c.r / 2, c.y);
      ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 2);
      ctx.stroke();
    });
    update();
  }

  function update() {
    confetti.forEach((c, i) => {
      c.tiltAngle += c.tiltAngleIncremental;
      c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
      c.x += Math.sin(0);
      c.tilt = Math.sin(c.tiltAngle - i) * 15;
    });
  }

  let animationId;
  function loop() {
    draw();
    animationId = requestAnimationFrame(loop);
  }

  loop();

  setTimeout(() => {
    cancelAnimationFrame(animationId);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }, 3000);
}

function startUpperGradeQuiz() {
  const container = document.getElementById("game-container");
  const currentPref = questionList[0]; // 出題中の都道府県

  const modeLabel = {
    lower: "とどうふけん　なまえクイズ",
    upper: "都道府県　名前クイズ",
    map: "都道府県　場所クイズ"
  };

  container.innerHTML = `
    <div id="mode-banner">${modeLabel[quizMode]}</div>
    <button id="back-button" onclick="showTitleScreen()">もどる</button>

    <img id="japan-map" src="images/japan.png" alt="日本地図" />
    <img id="highlight-pref" src="images/${currentPref.id}-2.png" alt="出題県" />

    <div id="question-text"><div id="question-count">問題 ${currentQuestionNumber} / ${questionCount}</div>この都道府県の<br>名前は？<br><br>漢字で正しく<br>入力しよう</div>

    <div id="input-area">
      <div id="answer-result"></div>
      <input type="text" id="text-answer" placeholder="ここに入力" autocomplete="off" />
    <div id="check-button-area">
      <button id="check-button" onclick="checkTextAnswer()">こたえあわせ</button>
    </div>
    </div>

    <div id="next-button-area"></div>
  `;

    const input = document.getElementById("text-answer");
  if (input) {
    input.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        checkTextAnswer();
      }
    });
  }
  
}

function checkTextAnswer() {
  const input = document.getElementById("text-answer");
  const userAnswer = input.value.trim();
  const correctPref = questionList[0];

  // エスケープ処理
  const safeUserAnswer = userAnswer.replace(/</g, "&lt;").replace(/>/g, "&gt;");

  const resultSymbol = (safeUserAnswer === correctPref.name)
  ? `⭕ 正解！`
  : `❌ 残念！`;


  // ⭐ 表示だけ書き換え
  const resultDiv = document.getElementById("answer-result");
  resultDiv.innerHTML = `${resultSymbol}<br>答え：${correctPref.name}`;

  if (safeUserAnswer === correctPref.name) {
    correctCount++;
  }

  input.disabled = true;
  document.getElementById("check-button").disabled = true;

  document.getElementById("next-button-area").innerHTML = `
    <button id="next-button" onclick="nextQuestion()">つぎへ →</button>
  `;
}

function startMapGame() {

if (!mapSupported || !hitMapReady) {
   const container = document.getElementById("game-container");
   container.innerHTML = `
     <div id="mode-banner">都道府県　場所クイズ</div>
     <button id="back-button" onclick="showTitleScreen()">もどる</button>
     <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
       <div style="background:#fff; border:3px solid #e86c00; border-radius:16px; padding:24px; text-align:center; max-width:520px; box-shadow:0 6px 20px rgba(0,0,0,.15);">
         <div style="font-weight:bold; font-size:24px; margin-bottom:8px;">このデバイスは<br>場所クイズモードに対応していません</div>
         <div style="font-size:16px; color:#555;">（メモリやブラウザ機能の制限が原因です）</div>
         <button id="back-to-title" onclick="showTitleScreen()" style="margin-top:16px; padding:10px 18px; border:none; border-radius:8px; background:#e86c00; color:#fff; font-weight:bold; cursor:pointer;">タイトルにもどる</button>
       </div>
     </div>
   `;
   return;
}
  if (!hitMapReady) {
    alert("地図の準備をしています。数秒後にもう一度お試しください。");
    return;
  }
  const container = document.getElementById("game-container");
  const currentPref = questionList[0]; // 出題中の都道府県

  const modeLabel = {
    lower: "とどうふけん　なまえクイズ",
    upper: "都道府県　名前クイズ",
    map: "都道府県　場所クイズ"
  };

  // 初期選択をリセット
  selectedPrefId = null;
  prefectures.forEach(p => {
    const img = document.getElementById(`pref-img-${p.id}`);
    if (img) img.src = `images/${p.id}-1.png`;
  });

  container.innerHTML = `
    <div id="mode-banner">${modeLabel[quizMode]}</div>
    <button id="back-button" onclick="showTitleScreen()">もどる</button>

    <!-- 問題文（上と同じ位置・スタイル） -->
    <div id="question-text">
      <div id="question-count">問題 ${currentQuestionNumber} / ${questionCount}</div>
      <ruby>${currentPref.name}<rt>${currentPref.yomi}</rt></ruby> の<br>
      ばしょは どこ？<br><br>
      クリック または タップ で<br>せんたくしてね
    </div>

    <!-- 47枚の白シルエット（z-index: 2で地図線画の下） -->
    <div id="silhouette-layer">
      ${prefectures.map(p => `
        <img
          id="pref-img-${p.id}"
          class="pref-sil"
          src="images/${p.id}-1.png"
          alt="${p.name}"
          onclick="selectPref(${p.id})"
        />
      `).join("")}
    </div>

    <!-- 日本地図線画（最前面） -->
    <img id="japan-map" src="images/japan.png" alt="日本地図" />

    <!-- 右下の「ここ！」ボタン -->
    <button id="confirm-button" onclick="checkMapAnswer()">ここ！</button>

    <div id="next-button-area"></div>
  `;

    container.removeEventListener('click', onMapClick);
    container.addEventListener('click', onMapClick, { passive: true });

}

function onMapClick(e) {
  const mapImg = document.getElementById("japan-map");
  const rect = mapImg.getBoundingClientRect();
  if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) return;

  // 画面 → natural座標
  const natX = (mapImg.naturalWidth  || rect.width)  * ((e.clientX - rect.left) / rect.width);
  const natY = (mapImg.naturalHeight || rect.height) * ((e.clientY - rect.top)  / rect.height);

  // natural → 縮小ヒットマップ座標
  let hx = Math.floor(natX * hitScaleX);
  let hy = Math.floor(natY * hitScaleY);

  if (!hitMapCtx || !hitMapCanvas) return;
  // はみ出し防止（NaN/負/大きすぎ を防ぐ）
  hx = Math.max(0, Math.min(hx, hitMapCanvas.width  - 1));
  hy = Math.max(0, Math.min(hy, hitMapCanvas.height - 1));

  if (!hitMapCtx) return;
  const id = hitMapCtx.getImageData(hx, hy, 1, 1).data[0];

  console.log({hx, hy, id, hitScaleX, hitScaleY}); //デバッグ

  if (id > 0) {
    selectPref(id);
  } else {
    const near = findNearId(hx, hy, 5); // ちょい広めに
    if (near) selectPref(near);
  }
}

function findNearId(hx, hy, r=5) {
  if (!hitMapCtx) return null;
  for (let dy=-r; dy<=r; dy++) {
    for (let dx=-r; dx<=r; dx++) {
      const a = hitMapCtx.getImageData(hx+dx, hy+dy, 1, 1).data[0];
      if (a > 0) return a;
    }
  }
  return null;
}

function selectPref(id) {
  console.log('tap:', id);

  // 以前の選択を白に戻す
  if (selectedPrefId !== null && selectedPrefId !== id) {
    const prev = document.getElementById(`pref-img-${selectedPrefId}`);
    if (prev) prev.src = `images/${selectedPrefId}-1.png`;
  }

  // 新しい選択をオレンジに
  const now = document.getElementById(`pref-img-${id}`);
  if (now) {
    now.src = `images/${id}-2.png`;
    selectedPrefId = id;
  }
}


function checkMapAnswer() {
  const correctId = questionList[0].id;

  if (selectedPrefId == null) {
    const btn = document.getElementById('confirm-button');
    if (btn) {
      const old = btn.textContent;
      btn.textContent = 'えらんでね';
      setTimeout(() => (btn.textContent = old), 900);
    }
    return;
  }

  const isCorrect = selectedPrefId === correctId;
  if (isCorrect) {
    correctCount++;
  } else {
    // 正解の県をオレンジに点灯
    const correctImg = document.getElementById(`pref-img-${correctId}`);
    if (correctImg) correctImg.src = `images/${correctId}-2.png`;

    // 誤タップした県はグレーに（いまオレンジでもフィルタでグレー化）
    const wrongImg = document.getElementById(`pref-img-${selectedPrefId}`);
    if (wrongImg) wrongImg.classList.add('dim-wrong');
  }

  // 入力ロック
  const container = document.getElementById("game-container");
  container.removeEventListener('click', onMapClick);
  const confirmBtn = document.getElementById('confirm-button');
  if (confirmBtn) confirmBtn.disabled = true;

  // 判定UI（既存の表示）
  let wrap = document.getElementById("map-result-wrap");
  if (!wrap) {
    wrap = document.createElement("div");
    wrap.id = "map-result-wrap";
    wrap.innerHTML = `
      <div id="map-result-panel"><div class="result-text"></div></div>
      <div id="map-next-area">
        <button id="next-button" onclick="nextQuestion()">つぎへ →</button>
      </div>
    `;
    container.appendChild(wrap);
  }
const textDiv = wrap.querySelector(".result-text");
if (isCorrect) {
  textDiv.innerHTML = `<span class="correct">⭕ せいかい！</span>`;
} else {
  textDiv.innerHTML = `
    <span class="wrong">❌ ざんねん！</span><br>
    <small style="color:#555;">せいかいは　オレンジいろ</small>
  `;
}
}

</script>

</body>
</html>
